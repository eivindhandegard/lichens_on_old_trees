---
title: "lichens_on_old_trees"
format: "html"
editor: visual
warning: false
---

### finding the directory

```{r}
here::here()

```

### Packages

```{r}
library(tidyverse)
library(readxl)
library(lme4)
library(here)
source("fun_lichens_old_trees.R")

```

### Species data import and formatting whole tree

```{r}


#importing the lichen data
lichen.data <- read_excel("lichen_data.xlsx", range = "B5:R31316")


# replacing in NA values in the numeric and logical variables####
lichen.data |>
  dplyr :: select(6:12) |>
  mutate(
    across(everything(), ~replace_na(.x, 0))
  )   -> data.subset

lichen.data[,6:12] <- data.subset


# finding the lichen species richness for each tree#####
lichen.data |>
  group_by(tree_number,locality,datatype, muncipality) %>%
  count(individuals > 0) |>
filter(`individuals > 0` == TRUE) |>
  arrange(locality,tree_number) -> lichen.data_richness


```

### Environmental variables import and formatting

```{r}


lichenoldtrees_treedata <- readxl::read_xlsx( "lichenoldtrees_treedata_corrected.xlsx", 
                                      range = "B7:AS407")

lichenoldtrees_treedata <-format_env_data(lichenoldtrees_treedata)



```

### Combining the species data with the environmental variables

```{r}

  
  # remember that all the column names have to match
  joined.fielddata <- full_join(lichenoldtrees_treedata, lichen.data_richness )
  
  joined.fielddata |>
    mutate(species = n) |>
    mutate(locality =factor(locality)) |>
    filter(!is.na(species)) -> species_richness_age

# making one dataframe for each tree species
species_richness_age |>
  filter(!tree_species == "spruce")  -> pine_species_richness_age

species_richness_age |>
  filter(!tree_species == "pine") -> spruce_species_richness_age
```

### Pine exploratory age plot

```{r}
  
pine_species_richness_age.plot <- exploratory_age_plot(pine_species_richness_age) 

# ggsave("pine_species_richness_age.plot.jpeg",pine_species_richness_age.plot, dpi = 250)
# 15.9 x 11.3 brukt tidligere


print(pine_species_richness_age.plot)
```

### Spruce exploratory age plot

```{r}

spruce_species_richness_age.plot <- exploratory_age_plot(spruce_species_richness_age)

print(spruce_species_richness_age.plot)
```

## Models species richness on the entire sample trees

Testing the following hypothesis:

Null hypothesis, H0s: No effect of tree age on lichen species diversity.

Prediction: No relationship between tree age and lichen richness

```{r}
#####

pinemod<- glmer.nb(species~ 
                  scale(age, center = T, scale = T) 
                + (1|plot/locality), data = pine_species_richness_age)


sprucemod <- glmer.nb(species~ scale(age, center = T, scale = T) 
                    + (1|plot/locality) , data = spruce_species_richness_age)


sjPlot:: tab_model(sprucemod,pinemod,  dv.labels = c("Spruce species richness", "Pine species richness"))
```

The lichen epiphyte richness is positively related to tree age for both species, and thus the first null hypothesis is rejected.

### Further alternative hypotheses

Alternative hypothesis H3: Species diversity increases with age because tree size increases with age, which in turn increases the surface for establishment of lichen species by long-distance dispersal (followed by more rapid dispersal on the tree).

Prediction  1: Species richness increases more with the size than with the age of trees.

```{r}
#####

pinemod<- glmer.nb(species~ 
                  scale(age, center = T, scale = T) 
                  + scale(dbh, center = T, scale = T)
                  + as.ordered(pine_species_richness_age$branch_thickness)
                + (1|plot/locality), data = pine_species_richness_age)


sprucemod <- glmer.nb(species~ scale(age, center = T, scale = T) 
                      + scale(dbh, center = T, scale = T)
                      + scale(branch_thickness.numeric, center = T, scale = T)
                    + (1|plot/locality) , data = spruce_species_richness_age)

sjPlot:: tab_model(sprucemod,pinemod,  dv.labels = c("Spruce species richness", "Pine species richness"))
```

The null hypothesis is rejected for spruce, but not none of the variables are significant for pine. The species richness is stronger related to branch thickness than to tree age, but tree age still remains significant. This will be further tested later from the sub-plots on the stem.

### Testing productivity

If H0 falsified because species diversity increases with age:

Alternative hypothesis H1: Species richness increases with age because of a longer time span for colonization.

Prediction: Species density increases with tree age.

Alternative hypothesis H2: Species diversity increases with age because growth stagnation in older trees facilitate establishment of lichens.

Prediction 1: Species density is more correlated with the average growth rate of the trees than their age.

```{r}
#####

pinemod<- glmer.nb(species~ 
                  scale(age, center = T, scale = T) 
                  + scale(site_index, center = T, scale = T)
                  + scale(elevation, center = T, scale = T)
                  + scale(basal_area, center = T, scale = T)
                + (1|plot/locality), data = pine_species_richness_age)


sprucemod <- glmer.nb(species~ scale(age, center = T, scale = T) 
                      + scale(site_index, center = T, scale = T)
                      + scale(elevation, center = T, scale = T)
                      + scale(basal_area, center = T, scale = T)
                    + (1|plot/locality) , data = spruce_species_richness_age)

sjPlot:: tab_model(sprucemod,pinemod,  dv.labels = c("Spruce species richness", "Pine species richness"))
```

### Testing everything at once

```{r}

pinemod<- glmer.nb(species~ 
                  scale(age, center = T, scale = T) 
                  + scale(site_index, center = T, scale = T)
                  + scale(dbh, center = T, scale = T)
                  + as.ordered(pine_species_richness_age$branch_thickness)
                  + scale(elevation, center = T, scale = T)
                + (1|plot/locality), data = pine_species_richness_age)

sprucemod <- glmer.nb(species~ scale(age, center = T, scale = T) 
                      + scale(site_index, center = T, scale = T)
                      + scale(dbh, center = T, scale = T)
                      + scale(branch_thickness.numeric, center = T, scale = T)
                      + scale(elevation, center = T, scale = T)
                    + (1|plot/locality) , data = spruce_species_richness_age)

sjPlot:: tab_model(sprucemod,pinemod,  dv.labels = c("Spruce species richness", "Pine species richness"))
```

## size independent inventory

Importing the species data from the plots

```{r}
#importing the lichen data####
lichen.data <- read_excel("lichen_data.xlsx", range = "B5:R31316")

# replacing in NA values in the numeric and logical variables####
lichen.data |>
  dplyr :: select(6:16) |>
  mutate(
    across(everything(), ~replace_na(.x, 0))
  )   -> data.subset

lichen.data[,6:16] <- data.subset



# finding the lichen species richness for each tree#####
lichen.data |>
  mutate(sub.plot = as.numeric(southside) + as.numeric(northside)) |>
  mutate(sub.plot = as.numeric(sub.plot > 0)) |>
   group_by(tree_number,locality,datatype, muncipality) %>%
  summarise( sum(sub.plot)) |>
  arrange(locality,tree_number)  -> lichen.data_richness.sub.plot
```

### Subplot figures

NB: The y axis is reduced to 14 to make it possible to see the pattern

```{r}

#importing the tree data

 
# remember that all the column names have to match
joined.fielddata <- full_join(lichenoldtrees_treedata, lichen.data_richness.sub.plot)


species_richness_age <- joined.fielddata |> 
  mutate(species = `sum(sub.plot)`)


species_richness_age |>
  filter(tree_species == "pine") -> pine_species_richness_age

species_richness_age |>
  filter(tree_species == "spruce")  -> spruce_species_richness_age



pine_species_richness_age.subplot <- exploratory_age_plot(pine_species_richness_age )
 
pine_species_richness_age.subplot +
  ylim(0,14)
#ggsave("pine_species_richness_age.subplot,.jpeg",pine_species_richness_age.subplot, dpi = 250)
# 15.9 x 11.3 brukt tidligere


print(pine_species_richness_age.subplot)

spruce_species_richness_age.subplot <- exploratory_age_plot(spruce_species_richness_age)

spruce_species_richness_age.subplot + 
  ylim(0,14)
#ggsave("spruce_species_richness_age.subplot.jpeg",spruce_species_richness_age.subplot, dpi = 250)

print(spruce_species_richness_age.subplot)
```

### Testing hypothesis 1

Alternative hypothesis H3: Species diversity increases with age because tree size increases with age, which in turn increases the surface for establishment of lichen species by long-distance dispersal (followed by more rapid dispersal on the tree).

Prediction  1: Species density ( number of species at a fixed area) increases trees than with the age of trees.

```{r}

#pinemodel
pine_species_richness_age |>
  filter(!is.na(locality )) -> pine_species_richness_age


pinemod_size_independent  <- glmer.nb(species~  
                      scale(age, center = T, scale = T)
                    #+ surface_area_tree_m2 
                    #+ scale(branch_thickness, center = T, scale = T) 
                    #+ bark_structure 
                    #+ scale(dbh, center = T, scale = T)
                    # + scale(site_index, center = T, scale = T)
                    #+ scale(basal_area, center = T, scale = T)
                    + (1|plot/locality) , data = pine_species_richness_age)


#spruce model

spruce_species_richness_age|>
  filter(!is.na(locality )) -> spruce_species_richness_age
sprucemod_size_independent <- glmer.nb(species~ scale(age, center = T, scale = T) 
                      #+ surface_area_tree_m2 
                      #+ scale(branch_thickness.numeric, center = T, scale = T) 
                      #+ bark_structure 
                      #+ scale(dbh, center = T, scale = T)
                      #+ scale(site_index, center = T, scale = T)
                      #+ scale(basal_area, center = T, scale = T)
                      + (1|plot/locality), data = spruce_species_richness_age)


sjPlot:: tab_model(sprucemod_size_independent ,pinemod_size_independent )
```

The null hypothesis is rejected for pine, but not spruce. The species density increases with tree age for pine. This might be because they have more open crowns that are not shading the stem.
