---
title: "lichens_on_old_trees"
format: "html"
editor: visual
warning: false
---

### finding the directory

```{r}
here::here()

```

### Packages

```{r}
library(tidyverse)
library(readxl)
library(lme4)
library(here)
source("fun_lichens_old_trees.R")

```

### Species data import and formatting whole tree

```{r}


#importing the lichen data
lichen.data <- read_excel("lichen_data.xlsx", range = "B5:R31316")


# replacing in NA values in the numeric and logical variables####
lichen.data |>
  dplyr :: select(6:12) |>
  mutate(
    across(everything(), ~replace_na(.x, 0))
  )   -> data.subset

lichen.data[,6:12] <- data.subset


# finding the lichen species richness for each tree#####
lichen.data |>
  group_by(tree_number,locality,datatype, muncipality) %>%
  count(individuals > 0) |>
filter(`individuals > 0` == TRUE) |>
  arrange(locality,tree_number) -> lichen.data_richness


```

### Environmental variables import and formatting

```{r}


lichenoldtrees_treedata <- readxl::read_xlsx( "lichenoldtrees_treedata_corrected.xlsx", 
                                      range = "B7:AS407")

lichenoldtrees_treedata <-format_env_data(lichenoldtrees_treedata)



```

### Combining the species data with the environmental variables

```{r}

  
  # remember that all the column names have to match
  joined.fielddata <- full_join(lichenoldtrees_treedata, lichen.data_richness )
  
  joined.fielddata |>
    mutate(species = n) |>
    mutate(locality =factor(locality)) |>
    filter(!is.na(species)) -> species_richness_age

# making one dataframe for each tree species
species_richness_age |>
  filter(!tree_species == "spruce")  -> pine_species_richness_age

species_richness_age |>
  filter(!tree_species == "pine") -> spruce_species_richness_age
```

### Pine exploratory age plot

```{r}
  
pine_species_richness_age.plot <- exploratory_age_plot(pine_species_richness_age) 

# ggsave("pine_species_richness_age.plot.jpeg",pine_species_richness_age.plot, dpi = 250)
# 15.9 x 11.3 brukt tidligere


print(pine_species_richness_age.plot)
```

### Spruce exploratory age plot

```{r}

spruce_species_richness_age.plot <- exploratory_age_plot(spruce_species_richness_age)

print(spruce_species_richness_age.plot)
```

### Models species richness on the entire sample trees

```{r}
#####

pinemod<- glmer.nb(species~ 
                  scale(age, center = T, scale = T) 
                  + scale(site_index, center = T, scale = T)
                  + scale(surface_area_tree_m2, center = T, scale = T)
                  + as.ordered(pine_species_richness_age$branch_thickness)
                  + scale(elevation, center = T, scale = T)
                + (1|plot/locality), data = pine_species_richness_age)


sprucemod <- glmer.nb(species~ scale(age, center = T, scale = T) 
                      + scale(site_index, center = T, scale = T)
                      + scale(surface_area_tree_m2, center = T, scale = T)
                      + scale(branch_thickness.numeric, center = T, scale = T)
                      #+ scale(elevation, center = T, scale = T)
                    + (1|plot/locality) , data = spruce_species_richness_age)



sjPlot:: tab_model(sprucemod,pinemod)


```

## size independent inventory

Importing the species data from the plots

```{r}
#importing the lichen data####
lichen.data <- read_excel("lichen_data.xlsx", range = "B5:R31316")

# replacing in NA values in the numeric and logical variables####
lichen.data |>
  dplyr :: select(6:16) |>
  mutate(
    across(everything(), ~replace_na(.x, 0))
  )   -> data.subset

lichen.data[,6:16] <- data.subset



# finding the lichen species richness for each tree#####
lichen.data |>
  mutate(sub.plot = as.numeric(southside) + as.numeric(northside)) |>
  mutate(sub.plot = as.numeric(sub.plot > 0)) |>
   group_by(tree_number,locality,datatype, muncipality) %>%
  summarise( sum(sub.plot)) |>
  arrange(locality,tree_number)  -> lichen.data_richness.sub.plot



```

### Subplot figures

```{r}

#importing the tree data

 
# remember that all the column names have to match
joined.fielddata <- full_join(lichenoldtrees_treedata, lichen.data_richness.sub.plot)


species_richness_age <- species_richness_age |> 
  mutate(species = `sum(sub.plot)`)


species_richness_age |>
  filter(tree_species == "pine") -> pine_species_richness_age

species_richness_age |>
  filter(tree_species == "spruce")  -> spruce_species_richness_age



pine_species_richness_age.subplot <- exploratory_age_plot(pine_species_richness_age )

#ggsave("pine_species_richness_age.subplot,.jpeg",pine_species_richness_age.subplot, dpi = 250)
# 15.9 x 11.3 brukt tidligere


print(pine_species_richness_age.subplot)

spruce_species_richness_age.subplot <- exploratory_age_plot(spruce_species_richness_age)

#ggsave("spruce_species_richness_age.subplot.jpeg",spruce_species_richness_age.subplot, dpi = 250)

print(spruce_species_richness_age.subplot)



```

### Models

```{r}

#pinemodel
pine_species_richness_age |>
  filter(!is.na(locality )) -> pine_species_richness_age


pinemod_size_independent  <- glmer.nb(species~  
                      scale(age, center = T, scale = T)
                    #+ surface_area_tree_m2 
                    #+ scale(branch_thickness, center = T, scale = T) 
                    #+ bark_structure 
                     #+ scale(dbh, center = T, scale = T)
                    # + scale(site_index, center = T, scale = T)
                    #+ scale(basal_area, center = T, scale = T)
                    + (1|plot/locality) , data = pine_species_richness_age)


#spruce model

spruce_species_richness_age|>
  filter(!is.na(locality )) -> spruce_species_richness_age
sprucemod_size_independent <- glmer.nb(species~ scale(age, center = T, scale = T) 
                      #+ surface_area_tree_m2 
                      #+ scale(branch_thickness.numeric, center = T, scale = T) 
                      #+ bark_structure 
                      #+ scale(dbh, center = T, scale = T)
                      #+ scale(site_index, center = T, scale = T)
                      #+ scale(basal_area, center = T, scale = T)
                      + (1|plot/locality), data = spruce_species_richness_age)


sjPlot:: tab_model(sprucemod_size_independent ,pinemod_size_independent )
```
